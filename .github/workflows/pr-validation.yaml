name: PR Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    if: github.event.repository.fork != true || vars.ENABLE_CI_IN_FORK == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run validation
        run: npm run validate

      - name: Check formatting
        run: npm run format:check

      - name: Run linter
        run: npm run lint

      - name: Run tests (if available)
        run: npm test --if-present

      - name: Run performance benchmarks
        run: |
          npm test -- src/tests/performance/token-generation-benchmark.test.js
          # Run comprehensive benchmarks
          node -e "
          const Benchmark = require('./src/utils/benchmark');
          const Generator = require('./src/components/TrustTokenGenerator');
          const gen = new Generator();
          const bench = new Benchmark({ generator: gen });
          bench.runComprehensiveTests().then(results => {
            console.log('Performance Results:', JSON.stringify(results.summary, null, 2));
            // Check SLA
            if (results.summary.overall.slaCompliance < 95) {
              console.error('SLA violation: ' + results.summary.overall.slaCompliance + '% < 95%');
              process.exit(1);
            }
            if (results.summary.overall.statistics.mean > 100) {
              console.error('Average response time violation: ' + results.summary.overall.statistics.mean + 'ms > 100ms');
              process.exit(1);
            }
          });
          "

      - name: Comment performance results on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            try {
              const results = execSync('node -e "
              const Benchmark = require(\'./src/utils/benchmark\');
              const Generator = require(\'./src/components/TrustTokenGenerator\');
              const gen = new Generator();
              const bench = new Benchmark({ generator: gen });
              bench.runComprehensiveTests().then(results => {
                console.log(JSON.stringify(results.summary));
              });
              "', { encoding: 'utf8' });
              const summary = JSON.parse(results.trim());
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: \`üöÄ **Performance Benchmark Results**
                
                **Overall Statistics:**
                - Average Response Time: \${summary.overall.statistics.mean.toFixed(2)}ms
                - P95 Response Time: \${summary.overall.statistics.p95.toFixed(2)}ms
                - SLA Compliance: \${summary.overall.slaCompliance.toFixed(2)}%
                
                **Worst Case:**
                - P95: \${summary.worstCase.p95.toFixed(2)}ms
                - SLA: \${summary.worstCase.slaCompliance.toFixed(2)}%
                
                ‚úÖ All performance targets met!\`
              });
            } catch (error) {
              console.log('Performance comment failed:', error.message);
            }

      - name: Comment on PR if checks fail
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **PR Validation Failed**
              
              This PR has validation errors that must be fixed before merging:
              - Run \`npm run validate\` to check agent/team configs
              - Run \`npm run format:check\` to check formatting (fix with \`npm run format\`)
              - Run \`npm run lint\` to check linting issues (fix with \`npm run lint:fix\`)
              
              Please fix these issues and push the changes.`
            })
