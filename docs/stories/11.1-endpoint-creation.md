# Story 11.1: Endpoint Creation - Brownfield Addition

## Status

Ready for Development

## Story

**As a** developer integrating with the sanitization API,  
**I want** a new `/api/sanitize/json` endpoint that accepts content input and returns sanitized JSON with trust tokens,  
**so that** I can programmatically sanitize content efficiently without reprocessing.

## Acceptance Criteria

**Functional Requirements:**

1. New POST `/api/sanitize/json` endpoint accepts JSON request with `content` field (required) and optional `classification` field
2. Endpoint validates request format and required fields, returning 400 for invalid requests
3. Endpoint integrates with existing SanitizationPipeline to process content
4. Response includes `sanitizedContent`, `trustToken`, and `metadata` fields in JSON format
5. Trust tokens are generated and included in response for reuse verification
6. Endpoint achieves <100ms average response time under normal load
7. Endpoint supports 100+ requests per second without degradation
8. Error handling returns appropriate HTTP status codes (400, 500) with error messages

**Integration Requirements:**

9. Endpoint follows existing API patterns for middleware, validation, and error handling
10. Access control and security headers applied using existing middleware
11. Audit logging captures sanitization operations and trust token generation
12. No regression in existing API endpoints functionality

**Quality Requirements:**

13. Endpoint covered by comprehensive unit and integration tests
14. API documentation updated with endpoint specifications
15. Performance benchmarks met and monitored
16. Backward compatibility maintained for all existing endpoints

## Tasks / Subtasks

- [ ] Implement endpoint route and basic structure (AC: 1, 2, 9)
  - [ ] Add POST `/api/sanitize/json` route to `src/routes/api.js`
  - [ ] Implement request validation middleware for JSON schema
  - [ ] Add required field validation for `content`
  - [ ] Return 400 Bad Request for invalid/missing fields

- [ ] Integrate sanitization pipeline (AC: 3, 4, 11)
  - [ ] Import and call SanitizationPipeline.sanitize() method
  - [ ] Handle pipeline errors with 500 status code
  - [ ] Integrate audit logging for sanitization operations
  - [ ] Add metadata calculation (original/sanitized length, timestamp)

- [ ] Implement trust token generation (AC: 5)
  - [ ] Integrate TrustTokenGenerator for token creation
  - [ ] Include token in JSON response structure
  - [ ] Ensure token generation doesn't impact performance targets

- [ ] Add comprehensive error handling (AC: 8)
  - [ ] Handle sanitization pipeline failures
  - [ ] Handle trust token generation errors
  - [ ] Return structured error responses
  - [ ] Log errors appropriately

- [ ] Performance optimization and testing (AC: 6, 7, 13, 15)
  - [ ] Implement performance tests for <100ms target
  - [ ] Load testing for 100+ RPS support
  - [ ] Optimize any bottlenecks in request processing
  - [ ] Add performance monitoring metrics

- [ ] Update documentation (AC: 14)
  - [ ] Document endpoint in API documentation
  - [ ] Include request/response schemas
  - [ ] Document error scenarios and status codes

- [ ] Regression testing (AC: 10, 12, 16)
  - [ ] Verify existing endpoints remain functional
  - [ ] Test access control and security headers
  - [ ] Ensure no breaking changes to API contracts

## Dev Notes

**Existing System Integration:**

- Integrates with: SanitizationPipeline, TrustTokenGenerator, existing API middleware
- Technology: Node.js/Express, follows existing route patterns in `src/routes/api.js`
- Follows pattern: RESTful POST endpoint with JSON request/response
- Touch points: Access control middleware, audit logging, error handling

**Integration Approach:** Extend existing API routes with new endpoint, reusing all existing middleware and patterns
**Existing Pattern Reference:** Follows `/api/documents/upload` pattern with validation, processing, and JSON response
**Key Constraints:** Must maintain <100ms performance, support high throughput, ensure security compliance

### Key Files to Create/Modify

#### Modified Files

- **`src/routes/api.js`**: Add new `/api/sanitize/json` route
  - Add route handler with validation middleware
  - Integrate sanitization pipeline and trust token generation
  - Return structured JSON response
  - Add error handling and logging

#### Integration Points

- Sanitization pipeline called with content and classification
- Trust token generated after sanitization completes
- Response follows existing JSON API patterns
- Error handling: Invalid requests (400), server errors (500)
- Performance: Endpoint must be optimized for low latency and high throughput

### Testing Standards

- Test file location: `src/tests/unit/` for unit tests, `src/tests/integration/` for API tests
- Test frameworks: Jest with supertest for API testing
- Testing patterns: Follow existing API test patterns
- Specific requirements: Test request validation, sanitization integration, trust token inclusion, error scenarios, performance benchmarks

**Risk and Compatibility Check:**

- **Primary Risk:** Performance impact from new endpoint processing
- **Mitigation:** Optimize pipeline calls, add caching if needed, monitor performance
- **Rollback:** Remove route handler, no impact on existing functionality
- **Compatibility:** Additive endpoint, no changes to existing APIs

## Change Log

| Date       | Version | Description                          | Author        |
| ---------- | ------- | ------------------------------------ | ------------- |
| 2025-11-08 | v1.0    | Initial story creation with template | Product Owner |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results</content>

<parameter name="filePath">docs/stories/11.1-endpoint-creation.md
