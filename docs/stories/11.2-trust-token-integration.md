# Story 11.2: Trust Token Integration - Brownfield Enhancement

## Status

Ready for Development

## Story

**As a** system integrator using the sanitization API,  
**I want** trust tokens to be automatically generated and included in JSON responses,  
**so that** sanitized content can be verified and reused without redundant processing.

## Acceptance Criteria

**Functional Requirements:**

1. Trust tokens are generated for all `/api/sanitize/json` requests with complete metadata
2. Token includes contentHash, originalHash, sanitizationVersion, rulesApplied, timestamp, expiresAt, signature
3. Tokens use HMAC-SHA256 signature with TRUST_TOKEN_SECRET for cryptographic security
4. Token expiration set to configurable default (24 hours) to prevent long-term storage
5. Token validation endpoint `/api/trust-tokens/validate` accepts and verifies tokens
6. Invalid tokens return 400 status, expired tokens return 410 status
7. Valid tokens return 200 with verification details including applied rules
8. Token generation adds minimal latency (<5ms) to overall response time

**Integration Requirements:**

9. TrustTokenGenerator component reused from existing implementation
10. Token generation integrated into sanitization pipeline output
11. Existing trust token validation endpoint remains functional
12. No changes to existing token formats or validation logic

**Quality Requirements:**

13. Token generation and validation covered by comprehensive unit tests
14. Cryptographic operations follow security best practices
15. Token metadata accurately reflects sanitization operations
16. No security vulnerabilities in token generation or validation

## Tasks / Subtasks

- [ ] Extend trust token generation for JSON endpoint (AC: 1, 2, 8)
  - [ ] Integrate TrustTokenGenerator.generateToken() in JSON endpoint response
  - [ ] Ensure all required token fields are populated
  - [ ] Optimize token generation for minimal performance impact
  - [ ] Add performance monitoring for token generation latency

- [ ] Implement token metadata accuracy (AC: 3, 4, 15)
  - [ ] Calculate contentHash from sanitized content
  - [ ] Calculate originalHash from input content
  - [ ] Include sanitizationVersion and rulesApplied array
  - [ ] Set proper timestamp and expiresAt fields

- [ ] Enhance token validation endpoint (AC: 5, 6, 7, 11)
  - [ ] Ensure `/api/trust-tokens/validate` handles JSON endpoint tokens
  - [ ] Return appropriate status codes for validation results
  - [ ] Include verification details in successful responses
  - [ ] Maintain backward compatibility with existing tokens

- [ ] Security implementation and validation (AC: 3, 14)
  - [ ] Verify HMAC-SHA256 signature generation
  - [ ] Ensure TRUST_TOKEN_SECRET environment variable usage
  - [ ] Implement secure random generation for token components
  - [ ] Add security-focused unit tests

- [ ] Comprehensive testing (AC: 13, 16)
  - [ ] Unit tests for token generation with various content types
  - [ ] Unit tests for token validation including edge cases
  - [ ] Integration tests for end-to-end token flow
  - [ ] Security testing for cryptographic operations

- [ ] Documentation updates (AC: 12)
  - [ ] Update API documentation for enhanced token usage
  - [ ] Document token schema and validation responses
  - [ ] Include security considerations for token handling

## Dev Notes

**Existing System Integration:**

- Integrates with: TrustTokenGenerator, existing `/api/trust-tokens/validate` endpoint
- Technology: Node.js crypto module, HMAC-SHA256, existing token validation patterns
- Follows pattern: Current trust token implementation in upload endpoint
- Touch points: Sanitization pipeline output, API response formatting

**Integration Approach:** Extend existing TrustTokenGenerator usage to JSON endpoint, reuse validation logic
**Existing Pattern Reference:** Follows trust token implementation from Story 5.3
**Key Constraints:** Must maintain cryptographic security, ensure minimal performance impact, preserve existing validation compatibility

### Key Files to Create/Modify

#### Modified Files

- **`src/routes/api.js`**: Enhance `/api/sanitize/json` endpoint
  - Integrate trust token generation in response
  - Ensure token metadata includes all sanitization details
  - Maintain existing validation endpoint functionality

- **`src/components/TrustTokenGenerator.js`**: Verify existing implementation
  - Confirm HMAC-SHA256 signature generation
  - Ensure proper field population for JSON responses
  - Optimize for performance if needed

#### Integration Points

- Token generation occurs after sanitization pipeline completes
- All token fields populated from sanitization results
- Validation endpoint handles both old and new token formats
- Security: Uses existing TRUST_TOKEN_SECRET, follows crypto best practices

### Testing Standards

- Test file location: `src/tests/unit/` for component tests, `src/tests/integration/` for API tests
- Test frameworks: Jest for unit testing, supertest for API validation
- Testing patterns: Follow existing trust token test patterns
- Specific requirements: Test cryptographic operations, token validation, expiration handling, security edge cases

**Risk and Compatibility Check:**

- **Primary Risk:** Token generation performance impact or security vulnerabilities
- **Mitigation:** Reuse proven TrustTokenGenerator, add performance monitoring, security review
- **Rollback:** Disable token generation in JSON endpoint, revert to basic response
- **Compatibility:** Additive enhancement, existing tokens and validation remain unchanged

## Change Log

| Date       | Version | Description                          | Author        |
| ---------- | ------- | ------------------------------------ | ------------- |
| 2025-11-08 | v1.0    | Initial story creation with template | Product Owner |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results</content>

<parameter name="filePath">docs/stories/11.2-trust-token-integration.md
