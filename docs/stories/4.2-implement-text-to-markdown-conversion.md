# Story 4.2: Implement Text to Markdown Conversion

## Status

**APPROVED** - Ready for development

## User Story

As a data processor, I want extracted PDF text to be converted into structured Markdown, so that document formatting and hierarchy are preserved for downstream processing.

## Acceptance Criteria

1. Raw text extraction output is converted to clean Markdown format.
2. Document structure is preserved (headings, paragraphs, lists where detectable).
3. Special characters and formatting are properly escaped for Markdown compatibility.
4. Page breaks and document sections are clearly marked in Markdown.
5. Document metadata is embedded as YAML frontmatter in the Markdown document.
6. Conversion process handles various PDF layouts and text encodings.
7. Output validation ensures Markdown syntax is valid and readable.

## Tasks / Subtasks

- [ ] Implement PDF text extraction using pdf-parse (AC: 1,6)
  - [ ] Add pdf-parse dependency
  - [ ] Create text extraction function
  - [ ] Handle PDF parsing errors and encoding issues
- [ ] Create text structure detection (AC: 2)
  - [ ] Detect headings based on font size/weight patterns
  - [ ] Identify paragraphs and line breaks
  - [ ] Detect lists and bullet points
- [ ] Implement Markdown conversion (AC: 1,2,3,4)
  - [ ] Convert headings to # syntax
  - [ ] Format paragraphs and lists
  - [ ] Escape special characters for Markdown compatibility
  - [ ] Add page breaks and section markers
- [ ] Add YAML frontmatter (AC: 5)
  - [ ] Add gray-matter dependency
  - [ ] Include document metadata (title, pages, author, creation date)
- [ ] Extend API endpoint (AC: 1,7)
  - [ ] Modify /api/documents/upload to optionally return Markdown
  - [ ] Add conversion option parameter
  - [ ] Integrate with existing sanitization pipeline
- [ ] Add validation and error handling (AC: 6,7)
  - [ ] Validate Markdown syntax using markdown-it
  - [ ] Handle encoding issues and special characters
  - [ ] Provide comprehensive error responses

## Dev Notes

### Relevant Source Tree

- `src/routes/api.js`: API endpoints (modify upload route)
- `src/components/`: Existing components (add text conversion component)
- `src/components/SanitizationPipeline/`: Use existing sanitization for extracted text
- `docs/architecture/tech-stack.md`: Technology choices (Node.js, Express)
- `docs/architecture/coding-standards.md`: Code standards (ESLint, async/await)

### Technical Context

- Use pdf-parse for text extraction (already available from Story 4.1)
- Extend existing upload endpoint to optionally return Markdown
- Store extracted text temporarily in memory
- Use gray-matter for YAML frontmatter handling
- Follow existing error handling patterns
- Apply sanitization to extracted text before Markdown conversion
- Ensure no malicious content is introduced during conversion process

### Testing Standards

- Unit tests in `src/tests/unit/`
- Integration tests in `src/tests/integration/`
- Test file naming: `*.test.js`
- Use Jest framework
- Mock PDF files for testing

## Testing

### Test Scenarios

- Valid PDF with structured text
- PDF with special characters
- PDF with multiple pages
- Invalid PDF files
- Large PDF files
- PDFs with encoding issues

### Validation Steps

1. Upload PDF and request Markdown conversion
2. Verify Markdown syntax is valid
3. Check YAML frontmatter contains metadata
4. Confirm text structure is preserved
5. Test error handling for invalid PDFs

## Implementation Notes

- Extract text from uploaded PDF using pdf-parse library
- Implement text structure detection (headings, paragraphs, lists)
- Convert structured text to Markdown format
- Add YAML frontmatter with document metadata
- Handle special characters and encoding issues
- Validate output Markdown syntax

### Example Input/Output

**Input PDF Text:**

```
Document Title
Some paragraph text here.
## Section Heading
- List item 1
- List item 2
```

**Output Markdown:**

```yaml
---
title: "Document Title"
pages: 1
processed_at: "2025-10-25T10:00:00Z"
---
# Document Title

Some paragraph text here.

## Section Heading

- List item 1
- List item 2
```

## Dependencies

- markdown processing libraries (if needed)
- yaml frontmatter library
- text processing utilities

## Validation Checklist

- ✅ **User Story**: Clear and follows proper format for data processing role
- ✅ **Acceptance Criteria**: 7 specific, testable criteria covering text conversion requirements
- ✅ **Technical Feasibility**: Implementation approach is sound using pdf-parse for extraction
- ✅ **Dependencies**: pdf-parse already available, may need additional libraries for Markdown processing
- ✅ **Testable**: All acceptance criteria can be verified through automated tests
- ✅ **Dependency**: Properly depends on Story 4.1 (PDF upload) being completed
- ✅ **Integration**: Can extend existing upload endpoint or create new conversion endpoint
- ✅ **Template Compliance**: All required sections present and complete
- ✅ **Implementation Details**: Comprehensive tasks, dev notes, and examples provided
- ✅ **Security**: Sanitization integration specified
- ✅ **AC-Task Mapping**: Tasks explicitly linked to acceptance criteria

## Required Dependencies to Add

- `gray-matter`: For YAML frontmatter handling
- `markdown-it` or similar: For Markdown processing/validation (optional)
- Text processing utilities may be built-in or use existing sanitization components

## Implementation Approach

**Option 1**: Extend upload endpoint to return both validation confirmation and extracted Markdown
**Option 2**: Create separate `POST /api/documents/convert` endpoint that takes uploaded PDF and returns Markdown
**Option 3**: Modify upload to store PDF temporarily and create conversion endpoint

**Recommended**: Option 1 - Extend upload endpoint for immediate processing and response

## Change Log

| Date       | Version | Description                                                          | Author   |
| ---------- | ------- | -------------------------------------------------------------------- | -------- |
| 2025-10-25 | 1.0     | Initial draft                                                        | PO Agent |
| 2025-10-25 | 1.1     | Added tasks, dev notes, testing sections                             | PO Agent |
| 2025-10-25 | 1.2     | Finalized for 10/10 readiness - added AC mapping, security, examples | PO Agent |

## Dev Agent Record

_(To be populated by development agent)_

## QA Results

_(To be populated by QA agent)_
