# Story 12.1: Implement API Contract Validation Middleware

## Status

Draft

## Story

**As a** developer,  
**I want** to implement API contract validation middleware using Joi schemas for request and response validation,  
**so that** data integrity is ensured while logging errors without disrupting service responses.

## Acceptance Criteria

1. Joi schemas are defined for request and response formats for all target endpoints (/health, /webhook/n8n, /documents/upload, /api/trust-tokens/validate).
2. Validation middleware performs non-blocking validation of incoming requests and outgoing responses.
3. Validation errors are logged using the existing logging infrastructure (Winston) without blocking the response flow.
4. The middleware integrates seamlessly with the Express middleware stack following existing patterns (e.g., AccessValidationMiddleware).
5. Existing API functionality remains unchanged and no regressions occur.
6. Unit tests cover the middleware logic and schema validations.

## Tasks / Subtasks

- [ ] Task 1: Define Joi validation schemas (AC: 1)
  - [ ] Create request schemas for /health (GET), /webhook/n8n (POST), /documents/upload (POST), /api/trust-tokens/validate (POST)
  - [ ] Create response schemas for each endpoint's expected output formats
  - [ ] Ensure schemas handle optional fields and data types correctly
- [ ] Task 2: Implement validation middleware function (AC: 2, 4)
  - [ ] Create middleware that accepts request/response schemas as parameters
  - [ ] Implement request validation before route handler execution
  - [ ] Implement response validation after route handler but before sending response
  - [ ] Ensure middleware is non-blocking and continues processing on validation errors
- [ ] Task 3: Add error logging functionality (AC: 3)
  - [ ] Integrate with existing Winston logging setup
  - [ ] Log validation errors with appropriate severity levels
  - [ ] Include request context in error logs for debugging
- [ ] Task 4: Create unit tests for middleware (AC: 6)
  - [ ] Test valid request/response scenarios
  - [ ] Test invalid request/response scenarios with error logging
  - [ ] Test non-blocking behavior
  - [ ] Ensure 80% code coverage for middleware components

## Dev Notes

### Existing System Integration

- **Technology Stack:** Node.js with Express.js, Joi for validation, Winston for logging
- **Integration Points:** Express middleware stack in src/routes/api.js, existing middleware patterns in src/middleware/
- **Existing Patterns:** Follow AccessValidationMiddleware.js structure for middleware implementation
- **Endpoints to Validate:** /health (GET), /webhook/n8n (POST), /documents/upload (POST), /api/trust-tokens/validate (POST)

### File Locations

- Middleware file: src/middleware/ApiContractValidationMiddleware.js (new)
- Schema definitions: src/schemas/api-contract-schemas.js (new)
- Tests: src/tests/unit/middleware/ApiContractValidationMiddleware.test.js (new)

### Testing Standards

- Use Jest framework for unit tests
- Tests located in src/tests/unit/ folder
- Follow existing test patterns from other middleware tests
- Aim for 80% overall coverage, 90% for critical validation logic

### Technical Constraints

- Non-blocking validation: Errors logged but processing continues
- Follow coding standards: ESLint, camelCase, async/await
- No console.log, use Winston logger
- Joi version compatible with existing dependencies

## Testing

- Unit tests for schema validation logic
- Unit tests for middleware error handling and logging
- Integration tests to verify non-blocking behavior

## Change Log

| Date       | Version | Description            | Author        |
| ---------- | ------- | ---------------------- | ------------- |
| 2025-11-08 | 1.0     | Initial story creation | Product Owner |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results</content>

<parameter name="filePath">docs/stories/12.1-implement-api-contract-validation-middleware.md
