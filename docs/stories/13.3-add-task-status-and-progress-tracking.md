# Story 13.3: Add Task Status and Progress Tracking

## Status

Ready for Development

## Story

**As a** API consumer (n8n workflows, client applications),  
**I want** to check the status and progress of asynchronous sanitization tasks,  
**so that** I can monitor job completion, retrieve results, and handle timeouts or failures appropriately.

## Acceptance Criteria

1. Status checking endpoints provide real-time job progress and completion status
2. Endpoints allow retrieval of sanitized results upon job completion
3. Status endpoints handle job not found, expired, and error states
4. Existing synchronous APIs remain unchanged and functional
5. Database schema changes are backward compatible
6. No disruption to existing n8n integration patterns
7. Performance impact on status checks is minimal
8. Comprehensive testing verifies existing functionality remains intact

## Tasks / Subtasks

- [ ] Task 1: Implement status checking endpoints (AC: 1, 3)
  - [ ] Create GET /api/jobs/{taskId}/status endpoint
  - [ ] Implement status response with progress, status, and result data
  - [ ] Add error handling for invalid taskIds and expired jobs
- [ ] Task 2: Implement result retrieval endpoints (AC: 2)
  - [ ] Create GET /api/jobs/{taskId}/result endpoint
  - [ ] Add result caching and cleanup logic
  - [ ] Handle partial results and streaming for large files
- [ ] Task 3: Add job lifecycle management (AC: 1, 3)
  - [ ] Implement job expiration and cleanup policies
  - [ ] Add progress update mechanisms from workers
  - [ ] Handle job cancellation if needed
- [ ] Task 4: Integration and compatibility testing (AC: 4, 5, 6, 7, 8)
  - [ ] Test existing synchronous endpoints remain functional
  - [ ] Verify n8n integration patterns work unchanged
  - [ ] Performance test status endpoint response times
  - [ ] Database testing for backward compatibility

## Dev Notes

### Previous Story Insights

Depends on Story 13.1 (queue infrastructure) and 13.2 (async endpoints). Status tracking builds on job submission from 13.2.

### Risk Profile

Updated risk assessment with 9 identified risks (3 critical, 1 high) covering status tracking, progress monitoring, and lifecycle management.

- **Risk Profile**: docs/qa/assessments/13.3-add-task-status-and-progress-tracking-risk-20251115.md
- **Critical Risks**: Incorrect endpoint implementation, job lifecycle bugs, queue integration issues
- **Key Mitigations**: Comprehensive testing, state machine design, integration validation

### Test Design

Expanded test strategy with 28 scenarios covering status tracking, result retrieval, and lifecycle management.

- **Test Design**: docs/qa/assessments/13.3-add-task-status-and-progress-tracking-test-design-20251115.md
- **Coverage**: Unit (12), Integration (10), E2E (6)
- **Priority**: P0 (18), P1 (8), P2 (2) - comprehensive coverage with risk-based focus

### Data Models

- JobStatus model from Story 13.1 with additional progress fields [Source: docs/stories/13.1-implement-job-queue-infrastructure.md]
- Add JobResult model for storing completed job outputs [Source: architecture/data-models.md]
- SanitizationEvent links to jobs via jobId [Source: architecture/data-models.md#SanitizationEvent]

### API Specifications

- New endpoint: GET /api/jobs/{taskId}/status - returns job status and progress [Source: architecture/rest-api-spec.md]
- New endpoint: GET /api/jobs/{taskId}/result - returns job results when complete [Source: architecture/rest-api-spec.md]
- Response formats follow existing API patterns [Source: architecture/rest-api-spec.md]

### Component Specifications

- Status controller integrates with queueManager from Story 13.1 [Source: docs/stories/13.1-implement-job-queue-infrastructure.md]
- Use existing ApiResponse wrapper for consistent responses [Source: architecture/coding-standards.md#Critical Rules]

### File Locations

- Status endpoints: src/routes/jobs.js [Source: architecture/source-tree.md#routes]
- Status controller: src/controllers/jobStatusController.js [Source: architecture/source-tree.md#controllers]
- Job result model: src/models/JobResult.js [Source: architecture/source-tree.md#models]

### Testing Requirements

- Unit tests for status and result endpoints [Source: architecture/test-strategy-and-standards.md#Unit Tests]
- Integration tests for end-to-end job lifecycle [Source: architecture/test-strategy-and-standards.md#Integration Tests]
- Mock queue and database for testing [Source: architecture/test-strategy-and-standards.md#Unit Tests]
- Test files in src/tests/unit/ and tests/integration/ [Source: architecture/source-tree.md#tests]

### Technical Constraints

- Use Express.js routing for new endpoints [Source: architecture/tech-stack.md#Technology Stack Table]
- Follow RESTful conventions for resource-based URLs [Source: architecture/high-level-architecture.md#High Level Overview]
- Use Joi for parameter validation [Source: architecture/tech-stack.md#Technology Stack Table]
- Implement caching for frequently accessed job statuses [Source: architecture/tech-stack.md]

## Testing

### Testing Standards

- Framework: Jest 29.7.0 for unit and integration tests [Source: architecture/test-strategy-and-standards.md]
- File Convention: \*.test.js alongside source files [Source: architecture/test-strategy-and-standards.md#Unit Tests]
- Location: src/tests/unit/ for unit tests, tests/integration/ for integration [Source: architecture/source-tree.md#tests]
- Coverage: 90% for new endpoint logic [Source: architecture/test-strategy-and-standards.md#Testing Philosophy]
- Mocking: Sinon for queue manager and database [Source: architecture/test-strategy-and-standards.md#Unit Tests]
- AAA Pattern: Arrange, Act, Assert for all tests [Source: architecture/test-strategy-and-standards.md#AI Agent Requirements]

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2025-11-15 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

TBD

### File List

TBD

## QA Results

TBD</content>
<parameter name="filePath">docs/stories/13.3-add-task-status-and-progress-tracking.md
