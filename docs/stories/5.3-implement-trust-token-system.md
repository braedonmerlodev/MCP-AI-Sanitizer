# Story 5.3: Implement Trust Token System - Brownfield Addition

## Status

Approved

## Story

**As a** content curator,  
**I want** sanitized content to include cryptographic trust tokens,  
**so that** previously sanitized content can be securely verified and reused without reprocessing.

## Acceptance Criteria

**Functional Requirements:**

1. Trust tokens are generated during sanitization with content hash, rules applied, and signature
2. Upload endpoint returns sanitized content plus trust token in response (basic PDF text extraction)
3. Tokens include expiration and version information for validation
4. Token validation endpoint allows verification of token authenticity
5. TrustTokenGenerator component handles cryptographic operations using HMAC-SHA256
6. TrustToken model manages token persistence and caching
7. Sanitization pipeline modified to return token alongside sanitized data

**Integration Requirements:**

8. Existing upload endpoint continues to work with enhanced response
9. New functionality follows existing API response pattern
10. Integration with sanitization pipeline maintains current behavior

**Quality Requirements:**

11. Change is covered by appropriate unit and integration tests
12. Documentation is updated for trust token usage
13. No regression in existing functionality verified

## Tasks / Subtasks

- [ ] Create TrustTokenGenerator component (AC: 1, 5)
  - [ ] Implement generateToken() method with HMAC-SHA256 signature
  - [ ] Implement validateToken() method for authenticity verification
  - [ ] Add token expiration and version handling
  - [ ] Create unit tests for cryptographic operations

- [ ] Create TrustToken model (AC: 6)
  - [ ] Define schema: contentHash, originalHash, sanitizationVersion, rulesApplied, timestamp, expiresAt, signature
  - [ ] Implement save/load methods for persistence
  - [ ] Add cache management functionality
  - [ ] Create model validation tests

- [ ] Modify sanitization pipeline (AC: 7)
  - [ ] Update sanitize() method to return { sanitizedData, trustToken } object
  - [ ] Integrate TrustTokenGenerator after sanitization steps
  - [ ] Track applied rules for token generation
  - [ ] Update existing pipeline tests

- [ ] Extend upload endpoint (AC: 2, 8, 9)
  - [ ] Add basic PDF text extraction using pdf-parse
  - [ ] Integrate with modified sanitization pipeline
  - [ ] Return enhanced JSON response with sanitizedContent and trustToken
  - [ ] Maintain backward compatibility
  - [ ] Add endpoint integration tests

- [ ] Add token validation endpoint (AC: 3, 4)
  - [ ] Implement /api/documents/{id}/validate route
  - [ ] Handle token validation requests
  - [ ] Return appropriate HTTP status codes (400 for invalid, 410 for expired)
  - [ ] Add validation endpoint tests

- [ ] Update documentation (AC: 12)
  - [ ] Document trust token usage and validation
  - [ ] Update API documentation for new endpoints
  - [ ] Add trust token schema documentation

## Dev Notes

**Existing System Integration:**

- Integrates with: /api/documents/upload endpoint and sanitization pipeline
- Technology: Node.js, crypto module for HMAC-SHA256
- Follows pattern: Current API response patterns with structured JSON
- Touch points: Upload endpoint response, sanitization pipeline output

**Integration Approach:** Extend upload endpoint to generate and include trust tokens in JSON response
**Existing Pattern Reference:** Follows current ApiResponse wrapper and JSON structure patterns
**Key Constraints:** Cryptographic operations must be performant, token format should be standardized

### Key Files to Create/Modify

#### New Components

- **`src/components/TrustTokenGenerator.js`**: Core cryptographic token generation using HMAC-SHA256
  - Methods: `generateToken()`, `validateToken()`
  - Dependencies: Built-in Node.js `crypto` module

- **`src/models/TrustToken.js`**: Data model for token persistence and validation
  - Schema: contentHash, originalHash, sanitizationVersion, rulesApplied, timestamp, expiresAt, signature
  - Methods: Save/load tokens, cache management

#### Modified Files

- **`src/components/sanitization-pipeline.js`**: Integrate token generation into `sanitize()` method
  - Return `{ sanitizedData, trustToken }` object instead of string
  - Generate token after sanitization steps complete

- **`src/routes/api.js`**: Extend `/api/documents/upload` endpoint
  - Add basic PDF text extraction using `pdf-parse` library
  - Call sanitization pipeline with extracted text
  - Return enhanced response with `sanitizedContent` and `trustToken` fields
  - Add new `/api/documents/{id}/validate` endpoint for token validation

#### Integration Points

- Trust token generation occurs **after** all sanitization steps but **before** returning result
- API responses follow existing JSON patterns with additive fields
- Error handling: Invalid tokens return 400, expired tokens return 410
- Avoid overlap with Epic 6: Focus on core token system, Epic 6 handles full PDF processing pipeline

### Testing Standards

- Test file location: `src/tests/unit/` for unit tests, `src/tests/integration/` for integration tests
- Test frameworks: Jest for unit and integration testing
- Testing patterns: Follow existing test patterns in codebase
- Specific requirements: Test cryptographic operations, token validation, API responses, performance impact

**Risk and Compatibility Check:**

- **Primary Risk:** Token generation could impact upload performance
- **Mitigation:** Optimize cryptographic operations and cache where possible
- **Rollback:** Remove token generation and revert to original response format
- **Compatibility:** No breaking changes to existing APIs (additive enhancement), database changes additive only

## Change Log

| Date       | Version | Description                          | Author       |
| ---------- | ------- | ------------------------------------ | ------------ |
| 2025-10-26 | v1.0    | Initial story creation with template | Scrum Master |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
