# Story 5.1: Implement Destination Tracking - Brownfield Addition

## Status

Ready for Review

## Story

**As a** system integrator,  
**I want** to track and identify MCP traffic destinations,  
**so that** the sanitization pipeline can determine when content will enter LLM context windows.

## Acceptance Criteria

1. Request metadata analysis identifies traffic destined for LLM consumption
2. Destination classification logic distinguishes LLM-bound vs non-LLM traffic
3. Classification metadata is attached to requests for pipeline use
4. Fallback classification defaults to full sanitization when unclear
5. Existing API endpoints continue to work unchanged
6. New functionality follows existing middleware pattern
7. Integration with sanitization pipeline maintains current behavior
8. Change is covered by appropriate unit and integration tests
9. Documentation is updated for new classification logic
10. No regression in existing functionality verified

## Tasks / Subtasks

- [x] Task 1: Design destination classification logic (AC: 1, 2, 4)
  - [x] Define classification rules based on request metadata (headers, paths, content types)
  - [x] Implement fallback to full sanitization for unclear cases
  - [x] Create classification metadata format for request attachment
- [x] Task 2: Implement middleware component (AC: 3, 5, 6)
  - [x] Create destination-tracking middleware in src/middleware/
  - [x] Integrate middleware into API routes before sanitization pipeline
  - [x] Attach classification metadata to request objects
- [x] Task 3: Update sanitization pipeline integration (AC: 7)
  - [x] Modify SanitizationPipeline.js to read classification metadata
  - [x] Ensure conditional processing based on destination
- [x] Task 4: Write unit and integration tests (AC: 8, 10)
  - [x] Create unit tests for middleware logic
  - [x] Create integration tests for API endpoints with classification
  - [x] Verify no regression in existing functionality
- [x] Task 5: Update documentation (AC: 9)
  - [x] Document classification logic and rules
  - [x] Update API documentation for middleware behavior

## Dev Notes

### Previous Story Insights

Story 4.1 completed PDF upload endpoint with validation and temporary storage. This provides the foundation for adding destination tracking middleware to the upload flow. [Source: docs/stories/4.1-implement-pdf-upload-and-validation.md]

### Data Models

No new data models required. Classification metadata will be attached to existing request objects as a simple object with destination type and confidence level. [Source: architecture/data-models.md]

### API Specifications

The /api/documents/upload endpoint will be enhanced with middleware that analyzes request context before processing. Classification results will be available in request metadata for downstream processing. [Source: architecture/rest-api-spec.md#/documents/upload]

Classification Logic:

- LLM-bound: Requests with headers like 'X-Destination: llm' or paths containing '/llm/', '/ai/', '/chat/'
- Non-LLM: File operations, tool calls, direct API access without LLM indicators
- Unclear: Default to full sanitization for security

### Component Specifications

DestinationTracking middleware will be a new component that analyzes request metadata and attaches classification results. It will integrate with the existing middleware chain. [Source: architecture/components.md#Middleware]

### File Locations

- New: src/middleware/destination-tracking.js
- Modified: src/routes/api.js (add middleware)
- Modified: src/components/SanitizationPipeline.js (read classification)
- Tests: src/tests/unit/middleware/destination-tracking.test.js, src/tests/integration/destination-tracking.test.js [Source: architecture/source-tree.md]

### Testing Requirements

Use Jest for unit testing middleware logic with mocked requests. Integration tests should verify end-to-end behavior with real API calls. Cover classification accuracy and fallback scenarios. [Source: architecture/test-strategy-and-standards.md#Unit Tests]

### Technical Constraints

- Node.js 20.11.0 LTS
- Follow camelCase for variables/functions, PascalCase for classes
- Use async/await for all async operations
- Log errors with Winston, no console.log in production
- All API responses use ApiResponse wrapper [Source: architecture/coding-standards.md]

## Testing

- Unit tests for destination tracking middleware
- Integration tests for API endpoints with classification
- Manual verification of classification accuracy

## Definition of Done

- [x] Functional requirements met
- [x] Integration requirements verified
- [x] Existing functionality regression tested
- [x] Code follows existing patterns and standards
- [x] Tests pass (existing and new)
- [x] Documentation updated if applicable

## Change Log

| Date       | Version | Description         | Author   |
| ---------- | ------- | ------------------- | -------- |
| 2025-10-26 | 1.0     | Initial story draft | PM Agent |

## Dev Agent Record

### Agent Model Used

dev

### Debug Log References

N/A

### Completion Notes List

- Implemented destination tracking middleware with comprehensive classification logic
- Integrated middleware into API routes with proper error handling
- Modified sanitization pipeline for conditional processing based on classification
- Created comprehensive unit and integration tests (18 total tests, all passing)
- Updated architecture documentation and API specifications
- All acceptance criteria met with no regressions in existing functionality

### File List

- New: src/middleware/destination-tracking.js
- Modified: src/routes/api.js (added middleware import and integration)
- Modified: src/components/sanitization-pipeline.js (added conditional sanitization)
- Modified: src/components/proxy-sanitizer.js (added options parameter)
- New: src/tests/unit/middleware/destination-tracking.test.js
- New: src/tests/integration/destination-tracking.test.js

## QA Results
