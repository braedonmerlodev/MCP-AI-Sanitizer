# Story 3.1: Implement n8n-Compatible API Endpoints

## Status

Done

## Story

**As a** n8n user,  
**I want** dedicated endpoints for calling agentic AI through the sanitizer,  
**so that** integrations are transparent and secure.

## Acceptance Criteria

1. Endpoints support n8n's webhook and API calling patterns.
2. Sanitization is applied automatically to all n8n requests/responses.
3. Documentation includes n8n integration examples.
4. End-to-end tests confirm seamless n8n workflows.

## Tasks / Subtasks

- [x] Task 1: Add n8n-compatible webhook endpoint (AC: 1, 2)
   - [x] Create POST /webhook/n8n endpoint in src/routes/api.js
   - [x] Implement request handling that accepts n8n webhook payload
   - [x] Integrate with SanitizationPipeline for automatic input sanitization
   - [x] Forward sanitized data to LLMs/MCP servers
   - [x] Apply output sanitization to responses before returning to n8n
- [x] Task 2: Update API documentation (AC: 3)
   - [x] Add /webhook/n8n endpoint to docs/architecture/rest-api-spec.md
   - [x] Include n8n integration examples in documentation
   - [x] Document webhook payload format and response structure
- [x] Task 3: Implement end-to-end tests (AC: 4)
   - [x] Create integration tests in tests/integration/ for n8n webhook flow
   - [x] Mock LLMs/MCP responses using WireMock
   - [x] Test bidirectional sanitization in n8n workflows
   - [x] Verify seamless integration without manual intervention

## Dev Notes

### Previous Story Insights

Story 2.1 implemented SymbolStripping and EscapeNeutralization components, integrated into SanitizationPipeline with sequential processing: normalization → stripping → neutralization → redaction. This provides the sanitization logic needed for automatic application to n8n requests/responses. [Source: docs/stories/2.1-implement-symbol-stripping-and-escape-neutralization.md]

### Data Models

SanitizationEvent model captures each sanitization action with id, timestamp, requestId, inputData, outputData, actionsTaken, provenanceValidated, and error fields. This will be used for logging n8n interactions. [Source: architecture/sanitizationevent.md]

### API Specifications

Current API has /sanitize POST for sanitizing input data and /health GET for health checks. Add POST /webhook/n8n to receive data from n8n, apply sanitization transparently, and return responses. Authentication via API key or webhook token. [Source: architecture/rest-api-spec.md, architecture/n8n-api.md]

### Component Specifications

ProxySanitizer acts as main entry point, routing requests through SanitizationPipeline. Add /webhook/n8n interface to ProxySanitizer, dependent on SanitizationPipeline for sanitization. [Source: architecture/components.md#ProxySanitizer]

### File Locations

- Modify: src/routes/api.js to add /webhook/n8n endpoint
- Modify: docs/architecture/rest-api-spec.md to document new endpoint
- New: tests/integration/n8n-webhook.test.js for e2e tests [Source: architecture/source-tree.md, architecture/test-strategy-and-standards.md#Integration Tests]

### Testing Requirements

Use Jest 29.7.0 for unit testing, WireMock for mocking LLMs/MCP in integration tests. Integration tests in tests/integration/, e2e tests to verify full n8n workflow with sanitization. Achieve 90% coverage for new endpoint logic. [Source: architecture/test-strategy-and-standards.md#Integration Tests, architecture/test-strategy-and-standards.md#E2E Tests]

### Technical Constraints

Node.js 20.11.0 LTS, Express.js 4.18.2 for API. Follow camelCase for variables/functions, PascalCase for classes. Use async/await, Winston for logging, no console.log. All API responses use ApiResponse wrapper. [Source: architecture/tech-stack.md, architecture/coding-standards.md]

## Testing

- Unit tests for new endpoint logic
- Integration tests for n8n webhook flow with mocked dependencies
- E2E tests simulating full n8n workflow

## Change Log

| Date       | Version | Description         | Author       |
| ---------- | ------- | ------------------- | ------------ |
| 2025-10-20 | 1.0     | Initial story draft | Scrum Master |
| 2025-10-20 | 1.1     | Story implemented   | dev          |
| 2025-10-20 | 1.2     | Story validated and approved | Product Owner |

## Dev Agent Record

### Agent Model Used

dev

### Debug Log References

### Completion Notes List

- Implemented POST /webhook/n8n endpoint in src/routes/api.js with automatic input and output sanitization
- Created ProxySanitizer.js as main entry point for handling n8n requests
- Added unit and integration tests for the new functionality
- Updated REST API spec with n8n endpoint documentation and examples
- All tests pass, full regression successful

### File List

- src/app.js (new)
- src/components/ProxySanitizer.js (new)
- src/routes/api.js (new)
- src/tests/unit/api.test.js (new)
- src/tests/integration/n8n-webhook.test.js (new)
- package.json (new)
- docs/architecture/rest-api-spec.md (modified)

## QA Results
