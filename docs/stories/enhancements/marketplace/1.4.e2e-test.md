# Story 1.4: End-to-End Data Flow Integration

## Status

Draft

## Story

**As a** QA engineer,
**I want to** verify the complete data flow from PDF upload to final JSON storage using an external MCP server,
**so that** I can ensure the system works as expected.

## Acceptance Criteria

1. Verify PDF upload triggers the `queueManager` and `jobWorker`.
2. Verify `ProxySanitizer` cleans the inbound text.
3. Verify `forwardToLLM` sends the cleaned text to the _selected_ MCP server.
4. Verify the response is received and passed through outbound sanitization (`handleN8nWebhook` or `AITextTransformer`).
5. Verify the final JSON is stored correctly.
6. Test with both a mock MCP server and a real connection if available.

## Tasks / Subtasks

- [ ] Create integration test `src/tests/integration/mcp-flow.test.js`
- [ ] Mock external MCP server responses (nock/jest)
- [ ] Test full pipeline: Upload -> Sanitize -> MCP -> Sanitize -> Result
- [ ] Verify database state (McpServer selection, JobResult)
- [ ] Manual verification via UI (optional but recommended)

## Dev Notes

- Use `supertest` for API calls
- Use `nock` to intercept external HTTP requests
- Ensure test database is clean

## Change Log

| Date       | Version | Description   | Author |
| ---------- | ------- | ------------- | ------ |
| 2025-11-30 | 1.0     | Initial draft | PO     |
