# Story 12.2: Integrate Validation into Target Endpoints

## Status

Draft

## Story

**As a** developer,  
**I want** to apply the API contract validation middleware to the specified endpoints,  
**so that** all target API endpoints have request and response validation enabled.

## Acceptance Criteria

1. Validation middleware is applied to /health endpoint for both request and response validation.
2. Validation middleware is applied to /webhook/n8n endpoint for both request and response validation.
3. Validation middleware is applied to /documents/upload endpoint for both request and response validation.
4. Validation middleware is applied to /api/trust-tokens/validate endpoint for both request and response validation.
5. Middleware integration follows Express middleware patterns and does not break existing functionality.
6. Integration tests verify that validation is active on all endpoints without regressions.

## Tasks / Subtasks

- [ ] Task 1: Update /health endpoint integration (AC: 1)
  - [ ] Import validation middleware in src/routes/api.js
  - [ ] Apply middleware to /health route with appropriate schemas
  - [ ] Test endpoint functionality remains intact
- [ ] Task 2: Update /webhook/n8n endpoint integration (AC: 2)
  - [ ] Apply validation middleware to /webhook/n8n route
  - [ ] Ensure webhook processing continues normally
  - [ ] Verify N8N integration is not affected
- [ ] Task 3: Update /documents/upload endpoint integration (AC: 3)
  - [ ] Apply validation middleware to /documents/upload route
  - [ ] Test file upload functionality with validation
  - [ ] Ensure document processing pipeline works
- [ ] Task 4: Update /api/trust-tokens/validate endpoint integration (AC: 4)
  - [ ] Apply validation middleware to /api/trust-tokens/validate route
  - [ ] Verify trust token validation logic remains functional
  - [ ] Test integration with existing access validation middleware
- [ ] Task 5: Create integration tests (AC: 6)
  - [ ] Write tests for each endpoint with validation active
  - [ ] Test valid and invalid requests/responses
  - [ ] Verify no regressions in existing endpoint behavior

## Dev Notes

### Existing System Integration

- **Integration Points:** src/routes/api.js where endpoints are defined
- **Existing Patterns:** Middleware application in Express routes, following AccessValidationMiddleware usage
- **Endpoints:** /health, /webhook/n8n, /documents/upload, /api/trust-tokens/validate
- **Dependencies:** Requires completion of Story 12.1 (validation middleware implementation)

### File Locations

- Main integration file: src/routes/api.js (modify)
- Integration tests: src/tests/integration/validation-endpoints.test.js (new)

### Testing Standards

- Integration tests in src/tests/integration/
- Use Jest and Supertest for API endpoint testing
- Test both valid and invalid scenarios
- Verify existing functionality through regression tests

### Technical Constraints

- Middleware must be applied in correct order in Express stack
- Ensure compatibility with existing middleware (AccessValidationMiddleware, destination-tracking)
- No changes to endpoint logic, only middleware addition

## Testing

- Integration tests for each endpoint with validation enabled
- Regression tests to ensure existing functionality works
- Manual testing of endpoint responses with validation errors logged

## Change Log

| Date       | Version | Description            | Author        |
| ---------- | ------- | ---------------------- | ------------- |
| 2025-11-08 | 1.0     | Initial story creation | Product Owner |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results</content>

<parameter name="filePath">docs/stories/12.2-integrate-validation-target-endpoints.md
