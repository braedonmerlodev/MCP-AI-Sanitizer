# Story 13.2: Convert Sanitization Endpoints to Asynchronous

## Status

Draft

## Story

**As a** backend developer,  
**I want** to modify specific sanitization API endpoints to submit jobs asynchronously and return task IDs immediately,  
**so that** long-running operations like PDF sanitization don't cause API timeouts while maintaining existing synchronous behavior for short tasks.

## Acceptance Criteria

1. PDF processing and generation endpoints submit jobs to queue and return task IDs within 100ms
2. Existing synchronous API endpoints remain unchanged and functional
3. Database schema changes are backward compatible
4. No disruption to existing n8n integration patterns
5. Performance impact on non-async operations is minimal (<5% overhead)
6. Comprehensive testing verifies existing functionality remains intact
7. Async endpoints handle job submission errors gracefully

## Tasks / Subtasks

- [ ] Task 1: Identify endpoints to convert (AC: 1, 2)
  - [ ] Review existing API endpoints for long-running operations (PDF upload, processing)
  - [ ] Determine which endpoints need async conversion based on timeout risks
- [ ] Task 2: Modify endpoint handlers for async submission (AC: 1, 7)
  - [ ] Update /documents/upload endpoint to submit PDF processing jobs
  - [ ] Update /api/sanitize/json endpoint for async processing when needed
  - [ ] Add job submission logic with error handling
- [ ] Task 3: Implement response format changes (AC: 1)
  - [ ] Modify response schemas to include taskId for async operations
  - [ ] Ensure backward compatibility for synchronous responses
- [ ] Task 4: Integration and compatibility testing (AC: 2, 3, 4, 5, 6)
  - [ ] Test existing synchronous endpoints remain functional
  - [ ] Verify n8n webhook integration works unchanged
  - [ ] Performance test to ensure <5% overhead
  - [ ] Database migration testing for backward compatibility

## Dev Notes

### Previous Story Insights

Story 13.1 implements the job queue infrastructure that this story depends on. Job queue must be complete before this story can submit jobs.

### Data Models

- Use JobStatus model from Story 13.1 for tracking async jobs [Source: docs/stories/13.1-implement-job-queue-infrastructure.md]
- SanitizationEvent model remains unchanged for synchronous operations [Source: architecture/data-models.md#SanitizationEvent]

### API Specifications

- /documents/upload: Modify to return {taskId: string} for async processing instead of direct results [Source: architecture/rest-api-spec.md#/documents/upload]
- /api/sanitize/json: Add optional async parameter, return taskId when async=true [Source: architecture/rest-api-spec.md#/api/sanitize/json]
- Maintain existing response formats for synchronous calls [Source: architecture/rest-api-spec.md]

### Component Specifications

- Integrate with queueManager from Story 13.1 [Source: docs/stories/13.1-implement-job-queue-infrastructure.md]
- Use existing SanitizationPipeline components in worker processes [Source: architecture/source-tree.md#SanitizationPipeline]

### File Locations

- Modified endpoints: src/routes/api.js [Source: architecture/source-tree.md#routes]
- New async handlers: src/controllers/asyncSanitizationController.js [Source: architecture/source-tree.md#controllers]
- Response models: src/models/ApiResponse.js (extend for async responses) [Source: architecture/source-tree.md#models]

### Testing Requirements

- Unit tests for modified endpoint handlers [Source: architecture/test-strategy-and-standards.md#Unit Tests]
- Integration tests for job submission and response handling [Source: architecture/test-strategy-and-standards.md#Integration Tests]
- Mock queue manager for testing [Source: architecture/test-strategy-and-standards.md#Unit Tests]
- Test files in src/tests/unit/ and tests/integration/ [Source: architecture/source-tree.md#tests]

### Technical Constraints

- Use Express.js middleware pattern for async handling [Source: architecture/tech-stack.md#Technology Stack Table]
- Follow RESTful API patterns [Source: architecture/high-level-architecture.md#High Level Overview]
- Use Joi for request validation [Source: architecture/tech-stack.md#Technology Stack Table]
- Maintain ApiResponse wrapper for all responses [Source: architecture/coding-standards.md#Critical Rules]

## Testing

### Testing Standards

- Framework: Jest 29.7.0 for unit and integration tests [Source: architecture/test-strategy-and-standards.md]
- File Convention: \*.test.js alongside source files [Source: architecture/test-strategy-and-standards.md#Unit Tests]
- Location: src/tests/unit/ for unit tests, tests/integration/ for integration [Source: architecture/source-tree.md#tests]
- Coverage: 90% for modified endpoint logic [Source: architecture/test-strategy-and-standards.md#Testing Philosophy]
- Mocking: Sinon for queue manager and external dependencies [Source: architecture/test-strategy-and-standards.md#Unit Tests]
- AAA Pattern: Arrange, Act, Assert for all tests [Source: architecture/test-strategy-and-standards.md#AI Agent Requirements]

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2025-11-15 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

TBD

### File List

TBD

## QA Results

TBD</content>
<parameter name="filePath">docs/stories/13.2-convert-sanitization-endpoints-to-asynchronous.md
