# Story 13.2: Convert Sanitization Endpoints to Asynchronous

## Status

Ready for Development

## Story

**As a** backend developer,  
**I want** to modify specific sanitization API endpoints to submit jobs asynchronously and return task IDs immediately,  
**so that** long-running operations like PDF sanitization don't cause API timeouts while maintaining existing synchronous behavior for short tasks.

## Acceptance Criteria

1. **Async Processing**: PDF processing endpoints submit jobs to queue and return task IDs within 100ms for files >10MB or processing time >5 seconds
2. **Backward Compatibility**: Existing synchronous API endpoints remain unchanged and functional with same response formats
3. **Database Compatibility**: Database schema changes are backward compatible with existing data
4. **Integration Preservation**: No disruption to existing n8n integration patterns or webhook processing
5. **Performance Threshold**: Performance impact on non-async operations is minimal (<5% overhead)
6. **Regression Prevention**: Comprehensive testing verifies existing functionality remains intact
7. **Error Handling**: Async endpoints handle job submission errors gracefully with appropriate HTTP status codes and error messages
8. **Result Retrieval**: Clients can retrieve async processing results via polling endpoint or webhook callbacks

## Tasks / Subtasks

- [ ] Task 1: Define async processing criteria and endpoint inventory (AC: 1, 2)
  - [ ] Define thresholds: files >10MB or processing time >5 seconds trigger async mode
  - [ ] Complete endpoint analysis: /documents/upload (async), /api/sanitize/json (conditional async)
  - [ ] Design result retrieval mechanism (polling endpoint + optional webhooks)
- [ ] Task 2: Implement async processing infrastructure (AC: 1, 7, 8)
  - [ ] Create AsyncSanitizationController with job submission logic
  - [ ] Implement job status endpoint (/api/jobs/{taskId}) for result polling
  - [ ] Add webhook callback support for async completion notifications
  - [ ] Update queue worker to handle sanitization jobs with proper error handling
- [ ] Task 3: Modify API endpoints and schemas (AC: 1, 2, 3)
  - [ ] Update /documents/upload to detect async conditions and submit jobs
  - [ ] Add async parameter to /api/sanitize/json endpoint
  - [ ] Modify response schemas to support both sync and async response formats
  - [ ] Ensure backward compatibility for existing synchronous calls
- [ ] Task 4: Risk mitigation and testing implementation (AC: 4, 5, 6, 7)
  - [ ] Implement API contract versioning and client notification system
  - [ ] Add comprehensive data validation for async processing
  - [ ] Execute complete test suite (15 scenarios) covering all ACs
  - [ ] Performance testing to validate <5% overhead on sync operations
  - [ ] Integration testing with n8n webhooks and existing clients

## Dev Notes

### Previous Story Insights

Story 13.1 implements the job queue infrastructure that this story depends on. Job queue must be complete before this story can submit jobs.

### Risk Profile

Risk assessment completed with 7 identified risks (1 critical, 2 high). Focus on API contract changes and integration complexity.

- **Risk Profile**: docs/qa/assessments/13.2-risk-20251115.md
- **Critical Risks**: API contract breaking changes, data corruption potential
- **Key Mitigations**: Client notifications, data validation, comprehensive testing

### Test Design

Comprehensive test strategy with 15 scenarios covering all acceptance criteria.

- **Test Design**: docs/qa/assessments/13.2-test-design-20251115.md
- **Coverage**: Unit (6), Integration (6), E2E (3)
- **Priority**: P0 (10), P1 (5) - all ACs covered

### Data Models

- Use JobStatus model from Story 13.1 for tracking async jobs [Source: docs/stories/13.1-implement-job-queue-infrastructure.md]
- SanitizationEvent model remains unchanged for synchronous operations [Source: architecture/data-models.md#SanitizationEvent]

### API Specifications

#### Modified Endpoints

- **POST /api/documents/upload**: Auto-detect async conditions (file >10MB), return `{taskId: string, status: "processing"}` for async, existing format for sync
- **POST /api/sanitize/json**: Add optional `async: boolean` parameter, return `{taskId: string, status: "processing"}` when async=true
- **GET /api/jobs/{taskId}**: New endpoint for polling async job status and results

#### Response Formats

- **Async Response**: `{taskId: string, status: "processing", estimatedTime: number}`
- **Sync Response**: Maintain existing formats (unchanged)
- **Job Status Response**: `{taskId: string, status: "processing|completed|failed", result?: object, error?: string, completedAt?: string}`

#### Backward Compatibility

- Existing synchronous calls work unchanged
- New async parameter defaults to false
- API versioning headers for contract management

### Component Specifications

- Integrate with queueManager from Story 13.1 [Source: docs/stories/13.1-implement-job-queue-infrastructure.md]
- Use existing SanitizationPipeline components in worker processes [Source: architecture/source-tree.md#SanitizationPipeline]

### File Locations

- Modified endpoints: src/routes/api.js [Source: architecture/source-tree.md#routes]
- New async controller: src/controllers/AsyncSanitizationController.js [Source: architecture/source-tree.md#controllers]
- Job status endpoint: src/routes/jobStatus.js [Source: architecture/source-tree.md#routes]
- Response models: src/models/JobResponse.js (new for async responses) [Source: architecture/source-tree.md#models]
- Updated schemas: src/schemas/api-contract-schemas.js [Source: architecture/source-tree.md#schemas]

### Testing Requirements

- **15 Test Scenarios**: Unit (6), Integration (6), E2E (3) covering all ACs [Source: docs/qa/assessments/13.2-test-design-20251115.md]
- **Priority Distribution**: P0 (10 critical), P1 (5 important) [Source: docs/qa/assessments/13.2-test-design-20251115.md]
- Risk-based testing focusing on API contracts, performance, and data integrity
- Mock queue manager and job status components for isolated testing
- Test files: src/tests/unit/asyncSanitizationController.test.js, src/tests/integration/async-processing.test.js, src/tests/e2e/async-workflow.test.js

### Technical Constraints

- Use Express.js middleware pattern for async handling [Source: architecture/tech-stack.md#Technology Stack Table]
- Follow RESTful API patterns [Source: architecture/high-level-architecture.md#High Level Overview]
- Use Joi for request validation [Source: architecture/tech-stack.md#Technology Stack Table]
- Maintain ApiResponse wrapper for all responses [Source: architecture/coding-standards.md#Critical Rules]

## Testing

### Testing Standards

- Framework: Jest 29.7.0 for unit and integration tests [Source: architecture/test-strategy-and-standards.md]
- File Convention: \*.test.js alongside source files [Source: architecture/test-strategy-and-standards.md#Unit Tests]
- Location: src/tests/unit/ for unit tests, tests/integration/ for integration [Source: architecture/source-tree.md#tests]
- Coverage: 90% for modified endpoint logic [Source: architecture/test-strategy-and-standards.md#Testing Philosophy]
- Mocking: Sinon for queue manager and external dependencies [Source: architecture/test-strategy-and-standards.md#Unit Tests]
- AAA Pattern: Arrange, Act, Assert for all tests [Source: architecture/test-strategy-and-standards.md#AI Agent Requirements]

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2025-11-15 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

TBD

### File List

TBD

## QA Results

### Review Date: 2025-11-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Story has been enhanced with comprehensive risk analysis and test design. Requirements are now well-defined with specific thresholds and clear implementation approach. Risk profile identifies critical concerns that must be addressed. Test design provides complete coverage across all acceptance criteria.

### Requirements Analysis

**Strengths:**

- ✅ Specific async triggers defined (file size >10MB, processing time >5 seconds)
- ✅ Complete endpoint inventory with conditional async logic
- ✅ Result retrieval mechanism designed (polling + webhooks)
- ✅ Risk mitigation strategies incorporated
- ✅ Comprehensive test coverage (15 scenarios)

**Technical Readiness:**

- ✅ Dependency on story 13.1 satisfied
- ✅ API contract evolution planned with backward compatibility
- ✅ Performance thresholds defined and testable
- ✅ Error handling and monitoring requirements specified

### Risk Assessment

**Critical Risks (Must Address):**

- API contract changes requiring client notifications and migration guides
- Data corruption potential in async processing requiring validation checks

**High Risks (Monitor Closely):**

- Integration complexity for clients requiring SDKs and documentation
- Performance implications requiring load testing

**Overall Risk Score:** 46/100 (Moderate - requires focused mitigation)

### Compliance Check

- **Story Structure**: ✅ Enhanced with risk profile and test design
- **Dependencies**: ✅ 13.1 complete, risk analysis completed
- **Technical Specs**: ✅ Detailed API specs, file locations, schemas
- **Testing Strategy**: ✅ 15 scenarios with proper prioritization
- **Architecture Alignment**: ✅ Follows existing patterns with extensions
- **Risk Management**: ✅ Critical risks identified with mitigation plans

### Recommendations

**Immediate Actions Required:**

1. **Implement Risk Mitigations**: API contract versioning, data validation, client notifications
2. **Execute Test Suite**: All 15 scenarios covering P0 and P1 priorities
3. **Performance Validation**: Load testing to ensure <5% overhead
4. **Integration Testing**: Full workflow testing with n8n and existing clients

**Technical Implementation Notes:**

- Use feature flags for gradual rollout of async functionality
- Implement comprehensive logging for async job tracking
- Add circuit breakers for queue submission failures
- Design webhook retry mechanism for reliable notifications

### Gate Status

Gate: PASS → Requirements clarified, risks identified with mitigation plans, comprehensive test design completed

### Recommended Status

Ready for Development - All clarifications addressed, risk mitigation planned, testing strategy defined</content>
<parameter name="filePath">docs/stories/13.2-convert-sanitization-endpoints-to-asynchronous.md
