# Testing Documentation

## TrustTokenGenerator Environment Validation Testing

This document outlines the testing scenarios and validation procedures for TrustTokenGenerator environment variable validation fixes implemented in security hardening epic 1.5.

### Environment Validation Test Scenarios

#### Constructor Validation Tests

- **TRUST_TOKEN_SECRET Required**: Verifies that TrustTokenGenerator throws an error when no secret is provided via options or environment variables
- **Options Priority**: Confirms that constructor options.secret takes precedence over environment variables
- **Environment Variable Support**: Validates that TRUST_TOKEN_SECRET environment variable is properly read
- **Custom Options**: Tests that defaultExpirationHours and defaultVersion options are accepted
- **Cross-Environment Compatibility**: Ensures functionality works across different secret formats and deployment environments

#### Token Generation Tests

- **Valid Token Structure**: Verifies all required fields are present (contentHash, originalHash, sanitizationVersion, rulesApplied, timestamp, expiresAt, signature)
- **Custom Options Override**: Tests that per-token options override constructor defaults
- **Hash Uniqueness**: Confirms different content produces different hashes
- **Type Validation**: Ensures all fields have correct data types

#### Token Validation Tests

- **Valid Token Acceptance**: Confirms correct tokens are validated successfully
- **Missing Fields Rejection**: Tests rejection of tokens missing required fields
- **Expired Token Handling**: Verifies expired tokens are properly rejected
- **Signature Tampering Detection**: Ensures signature validation prevents tampering
- **Content Modification Detection**: Confirms hash validation prevents content changes
- **Malformed Token Handling**: Tests graceful handling of invalid token formats

#### Integration Tests

- **Cross-Instance Compatibility**: Verifies tokens generated by one instance can be validated by another with same secret
- **Secret Isolation**: Confirms tokens from different secrets are rejected
- **End-to-End Workflow**: Tests complete generate → validate → reuse cycle

### Performance Benchmarks

#### Token Validation Performance

- **Average Response Time**: <0.02ms
- **95th Percentile**: <0.03ms
- **Throughput**: High (447KB/s for large content)

#### Content Hashing Performance

- **Small Content (<1KB)**: ~0.02ms average
- **Medium Content (1-10KB)**: ~0.01ms average
- **Large Content (>10KB)**: ~0.01ms average

#### Reuse Performance Improvement

- **Speedup Factor**: 2-5x faster than full sanitization
- **Memory Usage**: Stable, no significant leaks detected

### Environment Setup Requirements

#### Required Environment Variables

- `TRUST_TOKEN_SECRET`: Must be set for TrustTokenGenerator initialization
- `NODE_ENV`: Influences test behavior and logging levels

#### Test Environment Configuration

- All tests run with isolated environment variables
- Environment cleanup performed between test cases
- No persistent state between test executions

### Troubleshooting Common Issues

#### Environment Variable Not Set

```
Error: TRUST_TOKEN_SECRET environment variable must be set
```

**Solution**: Ensure TRUST_TOKEN_SECRET is set in environment or passed via constructor options

#### Token Validation Failures

- Check token expiration (default 24 hours)
- Verify secret consistency between generation and validation
- Confirm token structure integrity

#### Performance Issues

- Monitor token validation latency (>0.1ms may indicate issues)
- Check for memory leaks in long-running processes
- Verify cryptographic operations are not blocked

### Security Testing Notes

#### Cryptographic Validation

- SHA256 hashing for content integrity
- HMAC-SHA256 for signature verification
- Secure key management through environment variables

#### Tamper Prevention

- Signature validation prevents token modification
- Hash verification ensures content integrity
- Expiration prevents indefinite token validity

#### Audit Trail Integration

- All token operations logged through audit system
- Failed validations tracked for security monitoring
- Performance metrics collected for anomaly detection

### Maintenance Guidelines

#### Test Updates

- Add new test cases for environment validation edge cases
- Update performance benchmarks as system evolves
- Maintain test isolation and cleanup procedures

#### Documentation Updates

- Keep this document synchronized with code changes
- Update troubleshooting section with new issues
- Review performance benchmarks quarterly

#### Security Reviews

- Annual review of cryptographic implementations
- Regular testing of security controls
- Monitoring of performance degradation
